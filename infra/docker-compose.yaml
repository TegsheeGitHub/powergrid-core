# infra/docker-compose.yaml

# -----------------------------------------------------------------------------
# PowerGrid Local Orchestration
# -----------------------------------------------------------------------------
services:
  # ---------------------------------------------------------------------------
  # Service 1: Ingestion Engine (Go)
  # Simulates high-frequency energy meters.
  # ---------------------------------------------------------------------------
  ingestion-engine:
    build: 
      context: ../services/ingestion-engine
      dockerfile: Dockerfile
    container_name: powergrid-ingestion
    restart: always
    environment:
      - PORT=8080
      - LOG_LEVEL=debug
    networks:
      - powergrid-net

  # ---------------------------------------------------------------------------
  # Service 2: Intelligence API (Python / FastAPI)
  # Handles RAG and Regulatory Compliance queries.
  # ---------------------------------------------------------------------------
  intelligence-api:
    build:
      context: ../services/intelligence-api
      dockerfile: Dockerfile
    container_name: powergrid-intelligence
    restart: always
    environment:
      - PORT=8000
    networks:
      - powergrid-net

  # ---------------------------------------------------------------------------
  # Service 3: API Gateway (Nginx)
  # Single entry point simulating Azure API Management.
  # ---------------------------------------------------------------------------
  gateway:
    build:
      context: ../services/gateway
      dockerfile: Dockerfile
    container_name: powergrid-gateway
    ports:
      - "8080:80" # Host Port 8080 -> Container Port 80
    depends_on:
      - ingestion-engine
      - intelligence-api
    networks:
      - powergrid-net

  # ---------------------------------------------------------------------------
  # Service 4: Frontend (React - CRA)
  # Simulates the SharePoint Web Part / Power App.
  # ---------------------------------------------------------------------------
  web:
    build:
      context: ../web
      dockerfile: Dockerfile
    container_name: powergrid-web
    ports:
      - "3000:3000"
    environment:
      - VITE_API_URL=http://localhost:8080
      # CRA / Docker file-watching fixes
      - WDS_SOCKET_PORT=0
      - CHOKIDAR_USEPOLLING=true
    volumes:
      # Live reload for source code only
      - ../web/src:/app/src
      - ../web/public:/app/public
    networks:
      - powergrid-net

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------
networks:
  powergrid-net:
    driver: bridge
